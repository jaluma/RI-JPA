DROP TABLE TNOMINAS;
DROP TABLE TCONTRATOS;
DROP TABLE TTIPOCONTRATOS;
DROP TABLE TCATEGORIACONTRATOS;

CREATE TABLE TCATEGORIACONTRATOS (
	CATEGORIA_ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1, INCREMENT BY 1),
	NOMBRE VARCHAR(50) NOT NULL,
	TRIENIO_SALARIO DOUBLE NOT NULL,
	PRODUCTIVIDAD_PLUS DOUBLE NOT NULL,
	CONSTRAINT PK_CATEGORY PRIMARY KEY (CATEGORIA_ID)
);

CREATE TABLE TTIPOCONTRATOS (
	TIPO_ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1, INCREMENT BY 1),
	NOMBRE VARCHAR(50) NOT NULL,
	DIAS_COMPENSACION_POR_AÃ‘O DOUBLE NOT NULL,
	CONSTRAINT PK_TYPE PRIMARY KEY (TIPO_ID)	
);

CREATE TABLE TCONTRATOS (
	CONTRATO_ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1, INCREMENT BY 1),
	MECANICO_ID INTEGER NOT NULL,
	TIPO_ID INTEGER NOT NULL,
	CATEGORIA_ID INTEGER NOT NULL,
	FECHA_INICIAL DATE NOT NULL,
	FECHA_FIN DATE,
	SALARIO_BASE_ANUAL DOUBLE NOT NULL,
	COMPENSACION DOUBLE NOT NULL,
	STATUS VARCHAR(10) NOT NULL,
	CONSTRAINT PK_CONTRACT PRIMARY KEY (CONTRATO_ID),
	CONSTRAINT FK_MECHANIC FOREIGN KEY (MECANICO_ID) REFERENCES TMECANICOS(ID),
	CONSTRAINT FK_TYPE FOREIGN KEY (TIPO_ID) REFERENCES TTIPOCONTRATOS(TIPO_ID),
	CONSTRAINT FK_CATEGORY FOREIGN KEY (CATEGORIA_ID) REFERENCES TCATEGORIACONTRATOS(CATEGORIA_ID),
	CONSTRAINT CHECK_CONTRACT_ESTADO CHECK (STATUS IN ('ACTIVE', 'FINISHED'))
);

CREATE TABLE TNOMINAS(
	NOMINA_ID INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 1, INCREMENT BY 1),
	FECHA_N DATE NOT NULL,
	SALARIO_BASE DOUBLE NOT NULL,
	SALARIO_EXTRA DOUBLE NOT NULL,
	PRODUCTIVIDAD DOUBLE NOT NULL,
	TRIENIO DOUBLE NOT NULL,
	IRPF DOUBLE NOT NULL,
	SEGURIDAD_SOCIAL DOUBLE NOT NULL,
	CONTRATO_ID INTEGER NOT NULL,
	TOTAL_BRUTO DOUBLE,
	TOTAL_DESCUENTOS DOUBLE, 
	TOTAL_NETO DOUBLE,
	CONSTRAINT PK_PAYROLL PRIMARY KEY (NOMINA_ID),
	CONSTRAINT FK_CONTRACT FOREIGN KEY (CONTRATO_ID) REFERENCES TCONTRATOS(CONTRATO_ID),
	CONSTRAINT UNIQUE_PAYROLL UNIQUE (CONTRATO_ID, FECHA_N)
);

INSERT INTO TTIPOCONTRATOS VALUES (1, 'INDEFINIDOS', 5000);
INSERT INTO TTIPOCONTRATOS VALUES (2, 'OBRA', 2500);
INSERT INTO TTIPOCONTRATOS VALUES (3, 'TEMPORALES', 1000);

INSERT INTO TCATEGORIACONTRATOS VALUES (1, 'Jefes', 1067.40, 0.8);
INSERT INTO TCATEGORIACONTRATOS VALUES (2, 'Peon', 885.3, 0.5);
INSERT INTO TCATEGORIACONTRATOS VALUES (3, 'Ayudante', 770.10, 0.3);

INSERT INTO TCONTRATOS VALUES (1, 1, 1, 1, '2015-10-01', null, 5000, 0, 'ACTIVE');
INSERT INTO TCONTRATOS VALUES (2, 2, 2, 3, '2018-08-01', '2018-12-31', 2000, 0, 'ACTIVE');
INSERT INTO TCONTRATOS VALUES (3, 3, 2, 3, '2018-09-01', '2018-09-30', 800, 0, 'FINISHED');
INSERT INTO TCONTRATOS VALUES (4, 4, 2, 3, '2018-08-01', '2018-09-30', 800, 0, 'FINISHED');
INSERT INTO TCONTRATOS VALUES (5, 5, 3, 3, '2018-09-01', '2018-10-30', 1000, 0, 'ACTIVE');
INSERT INTO TCONTRATOS VALUES (6, 4, 2, 2, '2018-10-01', NULL, 1200, 0, 'ACTIVE');

DELETE FROM TSUSTITUCIONES WHERE INTERVENCION_ID in (select INTERVENCION_ID from TINTERVENCIONES WHERE AVERIA_ID >= 0 AND AVERIA_ID <= 10);
DELETE FROM TINTERVENCIONES WHERE AVERIA_ID >= 0 AND AVERIA_ID <= 10;

UPDATE TAVERIAS SET (DESCRIPCION,FECHA,IMPORTE,STATUS,VEHICULO_ID) = ('Aire acondicionado', '2018-09-05 09:00:00', 80, 'ABIERTA',11) where id=1;
UPDATE TAVERIAS SET (DESCRIPCION,FECHA,IMPORTE,STATUS,VEHICULO_ID) = ('Motor', '2018-09-15 09:00:00', 1500, 'ABIERTA', 12) where id=2;
UPDATE TAVERIAS SET (DESCRIPCION,FECHA,IMPORTE,STATUS,VEHICULO_ID) = ('Junta de una culata', '2018-09-30 09:00:00', 400, 'ABIERTA', 15) where id=3;
UPDATE TAVERIAS SET (DESCRIPCION,FECHA,IMPORTE,STATUS,VEHICULO_ID) = ('Luna rota', '2018-10-01 09:00:00', 100, 'ABIERTA', 20) where id=4;
UPDATE TAVERIAS SET (DESCRIPCION,FECHA,IMPORTE,STATUS,VEHICULO_ID) = ('Cambio de defensa', '2018-09-10 09:00:00', 1000, 'ABIERTA', 25) where id=5;
UPDATE TAVERIAS SET (DESCRIPCION,FECHA,IMPORTE,STATUS,VEHICULO_ID) = ('Cambio de frenos', '2018-09-19 09:00:00', 250, 'ABIERTA', 11) where id=6;

INSERT INTO TINTERVENCIONES(MINUTOS, AVERIA_ID, MECANICO_ID) VALUES(30, 1, 1);
INSERT INTO TINTERVENCIONES(MINUTOS, AVERIA_ID, MECANICO_ID) VALUES(340, 2, 2);
INSERT INTO TINTERVENCIONES(MINUTOS, AVERIA_ID, MECANICO_ID) VALUES(100, 3, 3);
INSERT INTO TINTERVENCIONES(MINUTOS, AVERIA_ID, MECANICO_ID) VALUES(60, 4, 4);
INSERT INTO TINTERVENCIONES(MINUTOS, AVERIA_ID, MECANICO_ID) VALUES(180, 5, 5);
INSERT INTO TINTERVENCIONES(MINUTOS, AVERIA_ID, MECANICO_ID) VALUES(65, 6, 1);